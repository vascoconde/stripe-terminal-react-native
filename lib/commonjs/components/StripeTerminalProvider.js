var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.StripeTerminalProvider=StripeTerminalProvider;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _types=require("../types");var _StripeTerminalContext=require("./StripeTerminalContext");var _functions=require("../functions");var _useListener=require("../hooks/useListener");var _reactNative=require("react-native");var _EventEmitter=_interopRequireDefault(require("react-native/Libraries/vendor/emitter/EventEmitter"));var _jsxFileName="/Users/vconde/Documents/stripe-terminal-react-native/src/components/StripeTerminalProvider.tsx";function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap();var cacheNodeInterop=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop;})(nodeInterop);}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj;}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}var _NativeModules$Stripe=_reactNative.NativeModules.StripeTerminalReactNative.getConstants(),FETCH_TOKEN_PROVIDER=_NativeModules$Stripe.FETCH_TOKEN_PROVIDER,CHANGE_CONNECTION_STATUS=_NativeModules$Stripe.CHANGE_CONNECTION_STATUS,CHANGE_PAYMENT_STATUS=_NativeModules$Stripe.CHANGE_PAYMENT_STATUS,FINISH_DISCOVERING_READERS=_NativeModules$Stripe.FINISH_DISCOVERING_READERS,FINISH_INSTALLING_UPDATE=_NativeModules$Stripe.FINISH_INSTALLING_UPDATE,REQUEST_READER_DISPLAY_MESSAGE=_NativeModules$Stripe.REQUEST_READER_DISPLAY_MESSAGE,REQUEST_READER_INPUT=_NativeModules$Stripe.REQUEST_READER_INPUT,REPORT_AVAILABLE_UPDATE=_NativeModules$Stripe.REPORT_AVAILABLE_UPDATE,REPORT_UNEXPECTED_READER_DISCONNECT=_NativeModules$Stripe.REPORT_UNEXPECTED_READER_DISCONNECT,REPORT_UPDATE_PROGRESS=_NativeModules$Stripe.REPORT_UPDATE_PROGRESS,START_INSTALLING_UPDATE=_NativeModules$Stripe.START_INSTALLING_UPDATE,UPDATE_DISCOVERED_READERS=_NativeModules$Stripe.UPDATE_DISCOVERED_READERS;var emitter=new _EventEmitter.default();var TOKEN_PROVIDER_ERROR_MESSAGE="Couldn't fetch connection token. Please check your tokenProvider method";function StripeTerminalProvider(_ref){var children=_ref.children,tokenProvider=_ref.tokenProvider,logLevel=_ref.logLevel;var _useState=(0,_react.useState)(false),_useState2=(0,_slicedToArray2.default)(_useState,2),isInitialized=_useState2[0],setIsInitialized=_useState2[1];var _useState3=(0,_react.useState)(true),_useState4=(0,_slicedToArray2.default)(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var _useState5=(0,_react.useState)(),_useState6=(0,_slicedToArray2.default)(_useState5,2),connectedReader=_useState6[0],setConnectedReader=_useState6[1];var _useState7=(0,_react.useState)([]),_useState8=(0,_slicedToArray2.default)(_useState7,2),discoveredReaders=_useState8[0],setDiscoveredReaders=_useState8[1];var log=(0,_react.useCallback)(function(code,message){if(logLevel==='verbose'){console.log("[Stripe terminal]: "+code,message);}},[logLevel]);var didUpdateDiscoveredReaders=(0,_react.useCallback)(function(_ref2){var readers=_ref2.readers;log('didUpdateDiscoveredReaders',readers);emitter==null?void 0:emitter.emit(UPDATE_DISCOVERED_READERS,readers);},[log]);var didFinishDiscoveringReaders=(0,_react.useCallback)(function(_ref3){var result=_ref3.result;log('didFinishDiscoveringReaders',result);emitter==null?void 0:emitter.emit(FINISH_DISCOVERING_READERS,result.error);},[log]);var didReportUnexpectedReaderDisconnect=(0,_react.useCallback)(function(_ref4){var error=_ref4.error;log('didReportUnexpectedReaderDisconnect',error);emitter==null?void 0:emitter.emit(REPORT_UNEXPECTED_READER_DISCONNECT,error);},[log]);var didReportAvailableUpdate=(0,_react.useCallback)(function(_ref5){var result=_ref5.result;log('didReportAvailableUpdate',result);emitter==null?void 0:emitter.emit(REPORT_AVAILABLE_UPDATE,result);},[log]);var didStartInstallingUpdate=(0,_react.useCallback)(function(_ref6){var result=_ref6.result;log('didStartInstallingUpdate',result);emitter==null?void 0:emitter.emit(START_INSTALLING_UPDATE,result);},[log]);var didReportReaderSoftwareUpdateProgress=(0,_react.useCallback)(function(_ref7){var result=_ref7.result;log('didReportReaderSoftwareUpdateProgress',result);emitter==null?void 0:emitter.emit(REPORT_UPDATE_PROGRESS,result.progress);},[log]);var didFinishInstallingUpdate=(0,_react.useCallback)(function(_ref8){var result=_ref8.result;log('didFinishInstallingUpdate',result);emitter==null?void 0:emitter.emit(FINISH_INSTALLING_UPDATE,result);},[log]);var didRequestReaderInput=(0,_react.useCallback)(function(_ref9){var result=_ref9.result;log('didRequestReaderInput',result);emitter==null?void 0:emitter.emit(REQUEST_READER_INPUT,result);},[log]);var didRequestReaderDisplayMessage=(0,_react.useCallback)(function(_ref10){var result=_ref10.result;log('didRequestReaderDisplayMessage',result);emitter==null?void 0:emitter.emit(REQUEST_READER_DISPLAY_MESSAGE,result);},[log]);var didChangePaymentStatus=(0,_react.useCallback)(function(_ref11){var result=_ref11.result;log('didChangePaymentStatus',result);emitter==null?void 0:emitter.emit(CHANGE_PAYMENT_STATUS,result);},[log]);var didChangeConnectionStatus=(0,_react.useCallback)(function(_ref12){var result=_ref12.result;log('didChangeConnectionStatus',result);emitter==null?void 0:emitter.emit(CHANGE_CONNECTION_STATUS,result);},[log]);(0,_useListener.useListener)(REPORT_AVAILABLE_UPDATE,didReportAvailableUpdate);(0,_useListener.useListener)(START_INSTALLING_UPDATE,didStartInstallingUpdate);(0,_useListener.useListener)(REPORT_UPDATE_PROGRESS,didReportReaderSoftwareUpdateProgress);(0,_useListener.useListener)(FINISH_INSTALLING_UPDATE,didFinishInstallingUpdate);(0,_useListener.useListener)(UPDATE_DISCOVERED_READERS,didUpdateDiscoveredReaders);(0,_useListener.useListener)(FINISH_DISCOVERING_READERS,didFinishDiscoveringReaders);(0,_useListener.useListener)(REPORT_UNEXPECTED_READER_DISCONNECT,didReportUnexpectedReaderDisconnect);(0,_useListener.useListener)(REQUEST_READER_INPUT,didRequestReaderInput);(0,_useListener.useListener)(REQUEST_READER_DISPLAY_MESSAGE,didRequestReaderDisplayMessage);(0,_useListener.useListener)(CHANGE_PAYMENT_STATUS,didChangePaymentStatus);(0,_useListener.useListener)(CHANGE_CONNECTION_STATUS,didChangeConnectionStatus);var tokenProviderHandler=function _callee(){var connectionToken;return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _regenerator.default.awrap(tokenProvider());case 3:connectionToken=_context.sent;(0,_functions.setConnectionToken)(connectionToken);_context.next=12;break;case 7:_context.prev=7;_context.t0=_context["catch"](0);(0,_functions.setConnectionToken)(undefined,TOKEN_PROVIDER_ERROR_MESSAGE);console.error(_context.t0);console.error(TOKEN_PROVIDER_ERROR_MESSAGE);case 12:case"end":return _context.stop();}}},null,null,[[0,7]],Promise);};(0,_useListener.useListener)(FETCH_TOKEN_PROVIDER,tokenProviderHandler);var _initialize=(0,_react.useCallback)(function _callee2(){var response;return _regenerator.default.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:setLoading(true);_context2.prev=1;_context2.next=4;return _regenerator.default.awrap(tokenProvider());case 4:_context2.next=11;break;case 6:_context2.prev=6;_context2.t0=_context2["catch"](1);console.error(TOKEN_PROVIDER_ERROR_MESSAGE);console.error(_context2.t0);return _context2.abrupt("return",{error:{code:_types.CommonError.Failed,message:TOKEN_PROVIDER_ERROR_MESSAGE}});case 11:_context2.next=13;return _regenerator.default.awrap((0,_functions.initialize)({logLevel:logLevel}));case 13:response=_context2.sent;if(response.error){log(response.error.code,response.error.message);}else if(response.reader){log('Connected to the reader: ',response.reader);setConnectedReader(response.reader);}if(!response.error){setIsInitialized(true);}setLoading(false);return _context2.abrupt("return",response);case 18:case"end":return _context2.stop();}}},null,null,[[1,6]],Promise);},[logLevel,tokenProvider,log]);var value=(0,_react.useMemo)(function(){return{loading:loading,isInitialized:isInitialized,connectedReader:connectedReader,discoveredReaders:discoveredReaders,setIsInitialized:setIsInitialized,setLoading:setLoading,setConnectedReader:setConnectedReader,setDiscoveredReaders:setDiscoveredReaders,log:log,initialize:_initialize,emitter:emitter};},[_initialize,loading,isInitialized,connectedReader,discoveredReaders,setIsInitialized,setLoading,setConnectedReader,setDiscoveredReaders,log]);return _react.default.createElement(_StripeTerminalContext.StripeTerminalContext.Provider,{value:value,__self:this,__source:{fileName:_jsxFileName,lineNumber:275,columnNumber:5}},children);}
//# sourceMappingURL=StripeTerminalProvider.js.map